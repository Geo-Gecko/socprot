<!DOCTYPE html>
<html>
	<head>
		<title>KCCA - UNICEF Interactive Map - Polygons</title>

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
		<link rel="stylesheet" href="css/leaflet.css" />
		<!--[if lte IE 8]><link rel="stylesheet" href="//cdn.leafletjs.com/leaflet-0.7.2/leaflet.ie.css" /><![endif]-->


		<link rel="stylesheet" href="../../assets/sidebar/css/leaflet-sidebar.css">
		<link rel="stylesheet" href="css/leaflet-tag-filter-button.css" />
		<link rel="stylesheet" href="../../assets/web/assets/mobirise-icons/mobirise-icons.css">
		<link rel="stylesheet" href="../../assets/mobirise/css/mbr-additional.css">
		<link rel="stylesheet" href="css/map.css">

		<style>
			body {
				padding: 0;
				margin: 0;
			}

			html, body, #map {
				height: 100%;
				font-size:  10pt;
			}

			.lorem {
				font-style: italic;
				color: #AAA;
			}
		</style>
	</head>
	<body>
		<div id="sidebar-left" class="sidebar collapsed">
			<!-- Nav tabs -->
			<div class="sidebar-tabs">
				<ul role="tablist">
					<li><a href="../../index.html"><i class="mbri-home mbr-iconfont mbr-iconfont-btn"></i></a></li>
					<li><a href="#home" role="tab"><i class="fa fa-filter"></i></a></li>
				</ul>

				<ul role="tablist">
					<li><a href="#settings" role="tab"><i class="fa fa-info"></i></a></li>
				</ul>
			</div>

			<!-- Tab panes -->
			<div class="sidebar-content">
				<div class="sidebar-pane" id="home" style="overflow-x: auto !important">
					<h4 class="sidebar-header" style="font-size: 0.8em; text-align: left;">Click on a parish to compare it against the district average
						<span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
					</h4>
					<p><strong>Selected Parish: </strong><span id='parish'></span>
						<br>
						<strong>Selected SubCounty: </strong><span id='subCounty'></span></p>
					<div id="statistics-list" class="custom-list" style="top:10px;"></div>
					<div id="statistics-legend" class="custom-list" style = "overflow: hidden; height: 50px;"></div>
				</div>



				<div class="sidebar-pane" id="settings">
					<h1 class="sidebar-header">About<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
				</div>
			</div>
		</div>

		<div id="map" class="sidebar-map"></div>

		<script src="js/leaflet.js"></script>
		<script src="../../assets/sidebar/js/leaflet-sidebar.js"></script>
		<script src="../../assets/web/assets/jquery/jquery.min.js"></script>
		<script src="js/d3.v3.min.js"></script>
		<script src="js/RadarChart.js"></script>

		<script>       

			$.fn.center = function () {
				this.css("position","absolute");
				this.css("bottom", "-5em"
						);
				this.css("right", "0px"
						);
				return this;
			}



			var storkmap = {};


			function makeMarkers() {
				var sidebar = L.control.sidebar('sidebar-left');
				storkmap.map.addControl(sidebar);

				sidebar.open('home');


				$.getJSON('./data/kampalaParishes_.geojson', function(data){
					function style(feature) {
						return {
							color: '#ff5500',
							fillOpacity: 0.5,
							opacity: 1,
							weight: 0.8
						};
					}


					var datalayer;
					var tooltip = d3.select(storkmap.map.getPanes().overlayPane)
					.append("div")
					.attr("class", "d3-tooltip d3-hide");
					function selectedStyle(feature) {
						return {
							color: '#00c5ff',
							fillOpacity: 0.5,
							zIndex:10000,
							opacity: 1,
							weight: 2
						};
					}
					var selected;
					function parishOnEachFeature(feature, featureLayer){

						var popup = L.popup()
						.setContent("<b>" + feature.properties.SNAME2014 + " Division</b></br>" +
									"<b>Parish: </b>" + feature.properties.PNAME2014 + "</br>");


						featureLayer.on({
							click: function(e) {
								datalayer.setStyle(style());
								selected = [];
								selected.push(e.target.feature.properties.PNAME2014);
								e.target.feature.properties.selected = true;
								e.target.setStyle(selectedStyle());
								e.target.bringToFront();

								//L.DomEvent.stopPropagation(e); // stop click event from being propagated further
							},
							mouseover: highlightFeature,
							mouseout: resetHighlight
						});

					}


					// function that renders a spider chart on to the slide bar


					datalayer = L.geoJson(data, {
						style: style,
						onEachFeature: parishOnEachFeature

					}).on('click', function (d) {

						for (var i = 0; i < data.features.length; i++) {
							if(selected[0] === data.features[i].properties.PNAME2014) {
								document.getElementById('parish').innerHTML = data.features[i].properties.PNAME2014;
								document.getElementById('subCounty').innerHTML = data.features[i].properties.SNAME2014;

								var ugChart = d3.select(".statUG").selectAll("rect");
								ugChart.attr("height", "20");

								d3.selectAll(".districtLegend").remove();

								var legend = d3.select('#statistics-legend').select("svg");
								var rectangles = legend.select('g');


								rectangles.append("rect")
									.attr("transform", "translate(0,25)")
									.attr("class", "districtLegend")
									.attr("width", "100px")
									.attr("height", "20px")
									.attr("fill", "#41b6c4");
								rectangles.append("text")
									.attr("class", "districtLegend")
									.attr("x", 6.33)
									.attr("y",  35)
									.attr("dy", ".35em")
									.style('fill', 'white')
									.text("Parish Averages");





								d3.csv('./data/dummydata2.csv', function (error, list) {
									var header = [];
									var values = [];
									for (var i = 0; i < data.features.length; i++) {
										if(selected[0] === data.features[i].properties.PNAME2014) {
											for (var k = 0; k < list.length; k++) {
												header.push(list[k].Column);
												values.push(data.features[i].properties[list[k].Column]);
											}
										}
									}
									d3.select(".statDist").remove();
									var chartDist = [header].concat([values]);
									//									console.log(chartDist);
									var valueLabelWidth = 10; // space reserved for value labels (right)
									var barHeight = 25; // height of one bar
									var barLabelWidth = 200; // space reserved for bar labels
									// var barLabelPadding = 5; // padding between bar and bar labels (left)
									var gridLabelHeight = 18; // space reserved for gridline labels
									var gridChartOffset = 3; // space between start of grid and first bar
									var maxBarWidth = 150; // width of the bar with the max value

									// accessor functions
									//             var barLabel = function(d) {  return d; };
									var barValue = function(d) { return parseFloat(d); };

									// scales
									var yScale = d3.scale.ordinal().domain(d3.range(0, chartDist[0].length)).rangeBands([0, chartDist[0].length * barHeight]);
									var y = function(d, i) { return yScale(i) * 1.5; };
									var x = d3.scale.linear().domain([0, 100/*d3.max(data, barValue)*/]).range([0, maxBarWidth]);
									// svg container element
									var chart = d3.select('#statistics-list').select("svg");
									// bars
									var barsContainer = chart.append('g')
									.attr("class", "statDist")
									.attr('transform', 'translate(' + barLabelWidth + ',' + (gridLabelHeight + gridChartOffset +10) + ')');
									barsContainer.selectAll("rect").data(chartDist[1]).enter().append("rect")
										.attr('y', y)
										.attr('height', yScale.rangeBand() / 2 * 0.8)
										.attr('width', function(d) { return x(barValue(d)); })
										.attr('stroke', 'white')
										.attr('fill', '#41b6c4');
									// bar value labels
									barsContainer.selectAll("text").data(chartDist[1]).enter().append("text")
										.attr("x", function(d) { return x(barValue(d)); })
										.attr("y", yText)
										.attr("dx", 3) // padding-left
										.attr("dy", "-.3em") // vertical-align: middle
										.attr("text-anchor", "start") // text-align: right
										.attr("fill", '#41b6c4')
										.attr("stroke", "none")
										.text(function(d) { return d3.round(barValue(d), 2); });
								});
							}
						}
					});
					var info = L.control();

					info.onAdd = function (map) {
						this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
						this.update();
						return this._div;
					};

					// method that we will use to update the control based on feature properties passed
					info.update = function (props) {
						this._div.innerHTML = (props ? 'Sub County: <b>' + props.SNAME2014 + '</b><br/>' + 
																		'Parish: <b>' + props.PNAME2014 + '</b>'
																		: 'Hover over a parish');
					};

					info.addTo(storkmap.map);


					function highlightFeature(e) {
						var layer = e.target;

						layer.setStyle({
							weight: 5,
							color: '#666',
							dashArray: '',
							fillOpacity: 0.7
						});

						if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
							layer.bringToFront();
						}
						info.update(layer.feature.properties);
					}


					function resetHighlight(e) {
						datalayer.resetStyle(e.target);
						info.update();
					}



					storkmap.map.addLayer(datalayer);


				});
				

				var header = [];
				var values = [];

				var chartData = [["%HH Head(10-17)", "%Distance to Public Health Facility (< 5kms)", "%Distance to Private Health Facility (< 5kms)", "%HH - No Kitchen", "%HH - Make shift Bathroom", "%HH - No bathroom", "%HH - No Toilet facility (bush or polythene bags or bucket)", "%HH - Public taps", "%Distance to Public Primary school (< 5kms)", "%HH - Tenement (Muzigo)","%HH - Floor (Earth)", "%HH - Floor (Rammed earth)","%HH - Wall (Mud and pole)", "HH poverty"],
								 ["0.4","90.2", "94.8", "37.8", "1.5", "0.7", "0.2", "35", "91.7", "52.9", "2.4", "1.5", "2.4", "0.37"]];

				//[headerList].concat([values]);

				var valueLabelWidth = 20; // space reserved for value labels (right)
				var barHeight = 25; // height of one bar
				var barLabelWidth = 200; // space reserved for bar labels
				var barLabelPadding = 15; // padding between bar and bar labels (left)
				var gridLabelHeight = 18; // space reserved for gridline labels
				var gridChartOffset = 3; // space between start of grid and first bar
				var maxBarWidth = 175; // width of the bar with the max value

				// accessor functions
				var barLabel = function(d) {  return d; };
				var barValue = function(d) { return parseFloat(d); };

				// scales
				var yScale = d3.scale.ordinal().domain(d3.range(0, chartData[0].length)).rangeBands([0, chartData[0].length * barHeight]);
				var y = function(d, i) { return yScale(i) * 1.5; };
				var yText = function(d, i) { return y(d, i) + yScale.rangeBand() / 2; };
				var x = d3.scale.linear().domain([0, 100/*d3.max(data, barValue)*/]).range([0, maxBarWidth]);
				// svg container element
				var chart = d3.select('#statistics-list').append("svg")
				.attr('width', maxBarWidth + barLabelWidth + valueLabelWidth)
				.attr('height', (gridLabelHeight + 20 + gridChartOffset + chartData[0].length * barHeight) * 1.5);
				// grid line labels
				var gridContainer = chart.append('g')
				.attr('transform', 'translate(' + barLabelWidth + ',' + gridLabelHeight + ')');
				gridContainer.selectAll("text").data(x.ticks(10)).enter().append("text")
					.attr("x", x)
					.attr("dy", -3)
					.attr("text-anchor", "middle")
					.text(function(d, i) { if( i === 1 || i === 3 || i === 5 || i === 7 || i === 9 ) { return } else return d});
				// vertical grid lines
				gridContainer.selectAll("line").data(x.ticks(10)).enter().append("line")
					.attr("x1", x)
					.attr("x2", x)
					.attr("y1", 0)
					.attr("y2", (yScale.rangeExtent()[1] + gridChartOffset) * 1.5)
					.style("stroke", "#ccc");
				// bar labels
				var labelsContainer = chart.append('g')
				.attr('transform', 'translate(' + (barLabelWidth - barLabelPadding) + ',' + (gridLabelHeight + gridChartOffset) + ')');
				labelsContainer.selectAll('text').data(chartData[0]).enter().append('text')
					.attr('y', yText)
					.attr('stroke', 'none')
					.attr('fill', 'black')
					.attr("dy", "0em") // vertical-align: middle
					.attr('text-anchor', 'end')
					.text(barLabel);
				// bars
				var barsContainer = chart.append('g')
				.attr("class", "statUG")
				.attr('transform', 'translate(' + barLabelWidth + ',' + (gridLabelHeight + gridChartOffset) + ')');
				barsContainer.selectAll("rect").data(chartData[1]).enter().append("rect")
					.attr('y', y)
					.attr('height', yScale.rangeBand() - 5)
					.attr('width', function(d) { return x(barValue(d)); })
					.attr('stroke', 'white')
					.attr('fill', '#E3784A');
				// bar value labels
				barsContainer.selectAll("text").data(chartData[1]).enter().append("text")
					.attr("x", function(d) { return x(barValue(d)); })
					.attr("y", yText)
					.attr("dx", 3) // padding-left
					.attr("dy", "-.3em") // vertical-align: middle
					.attr("text-anchor", "start") // text-align: right
					.attr("fill", "#E3784A")
					.attr("stroke", "none")
					.text(function(d) { return d3.round(barValue(d), 2); });
				// start line
				barsContainer.append("line")
					.attr("y1", -gridChartOffset)
					.attr("y2", (yScale.rangeExtent()[1] + gridChartOffset) * 1.5)
					.style("stroke", "#000");

				var legend = d3.select('#statistics-legend').append("svg")
				.attr("width", 100)
				.attr("height", 45);
				var rectangles = legend.append('g');


				rectangles.append("rect")
					.attr("width", "100px")
					.attr("height", "20px")
					.attr("fill", "#E3784A");
				rectangles.append("text")
					.attr("x", 3.01)
					.attr("y",  10)
					.attr("dy", ".35em")
					.style('fill', 'white')
					.text("District Averages");
			};

			function queryOverpass() {
				//var bbString = formatBBox(),
				//overpassQuery = encodeURIComponent("node" + '[birds_nest=stork]' + bbString + ";out body;"),
				overpassURL = './json/interpreter.json'

				$.ajax({
					url: overpassURL,
					type: 'GET',
					crossDomain: true,
					success: function (data) {
						storkmap.osmJson = data.elements;
						makeMarkers();						
					},
				});
			};

			function onMapViewReset(e) {
				queryOverpass();
			};

			function onMapMoveEnd(e) {
				queryOverpass();
			};

			function makeMap() {

				var map = storkmap.map;

				queryOverpass();

				map.setView([0.3193, 32.5953], 12);


			};

			var attr_osm = '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';
			var attr_nests = 'data via <a href="http://www.overpass-api.de/" target=”_blank”>Overpass API</a>';
			var attr_dev = 'web map funded by <a href="https://www.giz.de/en/worldwide/310.html" target=”_blank”>GIZ-Uganda</a> and created by <a href="http://geogecko.com" target=”_blank”>GeoGecko</a>';

			var layerOSM = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_nolabels/{z}/{x}/{y}.png', {
				attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
				subdomains: 'abcd',
				maxZoom: 19
			});

			storkmap.map = L.map('map', {
				attributionControl: false,
				layers: [layerOSM],
				zoomControl: false,
				minZoom: 6
			});




			//			L.control.attribution({position: 'bottomleft'}).addTo(storkmap.map);
			storkmap.currentTag = "water_point";

			storkmap.osmJson = {};
			makeMap();


		</script>		

	</body>
</html>
